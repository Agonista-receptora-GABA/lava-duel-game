name: Deploy Lava Duel to GKE
on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker europe-west4-docker.pkg.dev
        echo "Docker auth configured for $(gcloud auth list --filter=status:ACTIVE --format='value(account)')"

    - name: Build & Push Docker Image
      run: |
        IMAGE="europe-west4-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/lava-duel/lava-duel:latest"
        echo "Building $IMAGE"
        docker build -t $IMAGE .
        docker push $IMAGE

    - uses: google-github-actions/get-gke-credentials@v2
      with:
        clusterName: ${{ secrets.GKE_CLUSTER_NAME }}
        location: ${{ secrets.GKE_ZONE }}
        projectId: ${{ secrets.GCP_PROJECT_ID }}

    - name: Deploy to GKE
      run: |
        kubectl rollout restart deployment/lava-duel
        kubectl rollout status deployment/lava-duel --timeout=300s
