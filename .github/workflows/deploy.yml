name: Deploy Lava Duel to GKE
on:
  push:
    branches: [master]
    
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - uses: google-github-actions/setup-gcloud@v2
    
    # Build + Push Docker
    - name: Build and Push
      run: |
        IMAGE=europe-west4-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/lava-duel/lava-duel:latest
        docker build -t $IMAGE .
        docker push $IMAGE
    
    # Deploy to GKE
    - name: Deploy
      run: |
        gcloud container clusters get-credentials lava-duel-cluster --zone=europe-west4-a --project=${{ secrets.GCP_PROJECT_ID }}
        kubectl set image deployment/lava-duel-service lava-duel=$IMAGE
        kubectl rollout status deployment/lava-duel-service
